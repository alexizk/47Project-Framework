<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Plan_Runner_Spec.md</title>
<style>
body { font-family: system-ui, Segoe UI, Arial, sans-serif; margin: 2rem; line-height: 1.5; max-width: 1100px; }
pre { white-space: pre-wrap; word-wrap: break-word; background: #f6f8fa; padding: 1rem; border-radius: 12px; }
code { background: #f6f8fa; padding: 0.1rem 0.2rem; border-radius: 6px; }
a { color: #0b57d0; }
table { border-collapse: collapse; }
td, th { border: 1px solid #ddd; padding: 6px 10px; }
</style>
</head>
<body>
<h1>Plan Runner Specification (v1)</h1>

<p>Date: 2025-12-26</p>

<p>This document defines the <strong>execution contract</strong> for <code>47 plan run</code>.</p>

<h2>Commands</h2>

<ul>
<li><code>47 plan validate &lt;path&gt;</code>: schema + semantic validation</li>
<li><code>47 plan run &lt;path&gt; [--whatif|--apply] [--continueOnError] [--force] [--json]</code></li>
<li><code>47 plan status [--last] [--runId &lt;id&gt;]</code></li>
</ul>

<h2>Modes</h2>

<ul>
<li><code>--whatif</code>: compute intended changes and produce a journal; <strong>no mutation</strong></li>
<li><code>--apply</code>: execute steps</li>
</ul>

<h2>Step model</h2>

<p>Each plan contains an ordered list of steps.</p>

<p>Common step fields:
- <code>id</code> (string, unique in plan)
- <code>type</code> (string)
- <code>name</code> (string, optional)
- <code>dependsOn</code> (array of step ids, optional)
- <code>timeoutSec</code> (number, optional)
- <code>retry</code> (object, optional)
- <code>when</code> (condition object, optional)</p>

<h2>Step types (v1 baseline)</h2>

<ul>
<li><code>exec</code>: run a process/script with controlled environment</li>
<li><code>copy</code>: copy files with safety checks</li>
<li><code>download</code>: download to cache with hash verification</li>
<li><code>registry</code>: set/read registry values (Windows)</li>
<li><code>env</code>: set environment variables</li>
<li><code>service</code>: manage Windows services</li>
<li><code>task</code>: manage scheduled tasks</li>
<li><code>module.call</code>: call a module-exposed action/command</li>
</ul>

<h2>Idempotency</h2>

<p>Steps should be idempotent. Each step type may define:
- <code>check</code>: determines if step is already satisfied
- <code>apply</code>: makes changes</p>

<h2>Results and exit codes</h2>

<p>A run produces:
- runId
- snapshotId (if created)
- journal path
- step results</p>

<p>Failure taxonomy (recommended):
- validation error
- policy denied
- prerequisite missing
- execution failure
- timeout</p>

<p>See <code>docs/Operator_UX_and_Exit_Codes.md</code>.</p>

<h3>Exec step payload</h3>

<p>For <code>type: "exec"</code>, include an <code>exec</code> object:</p>

<ul>
<li><code>exec.file</code> (string, required): command to run (absolute, relative to plan folder, or resolvable via PATH).</li>
<li><code>exec.args</code> (array of strings, optional): arguments.</li>
<li><code>exec.cwd</code> (string, optional): working directory (defaults to the plan folder).</li>
<li><code>exec.env</code> (object, optional): environment variables to add/override for the process.</li>
<li><code>exec.timeoutSec</code> (number, optional): timeout override for this step.</li>
<li><code>exec.okExitCodes</code> (array of numbers, optional): allowed exit codes (default <code>[0]</code>).</li>
<li><code>exec.captureMaxKB</code> (number, optional): max captured stdout/stderr per stream in JSON results (full output is still written to files).</li>
</ul>

<h4>Idempotency check</h4>

<p>Steps may include a <code>check</code> object. If the check is satisfied, the step is skipped.</p>

<p>Supported checks:</p>

<ul>
<li><code>check.type: "pathExists"</code> with <code>check.path</code> (path may be relative to plan folder)</li>
<li><code>check.type: "exec"</code> with <code>check.exec</code> (runs only in Apply mode)
<ul>
<li><code>check.exec.file</code> (required), <code>check.exec.args</code>, <code>check.exec.cwd</code>, <code>check.exec.timeoutSec</code>, <code>check.exec.expectExitCode</code> (default <code>0</code>)</li>
</ul></li>
</ul>

<p>Notes:
- In <code>WhatIf</code> mode, <code>check.type: "exec"</code> is <strong>not executed</strong> (to avoid side effects).
- In <code>Apply</code> mode, full outputs are saved under the run folder: <code>runs/&lt;runId&gt;/steps/&lt;stepId&gt;/stdout.txt</code> and <code>stderr.txt</code>.</p>

<h3>Download step payload</h3>

<p>For <code>type: "download"</code>, include a <code>download</code> object:</p>

<ul>
<li><code>download.url</code> (string, required): remote URL (http/https) <strong>or</strong> a local path (absolute or relative to plan folder) for offline plans.</li>
<li><code>download.dest</code> (string, optional): destination file path (absolute or relative to plan folder). If omitted, the payload is saved under the run's step artifacts folder.</li>
<li><code>download.sha256</code> (string, optional): expected SHA256 hex digest. If provided, the download is verified and caching is keyed by hash.</li>
<li><code>download.headers</code> (object, optional): HTTP headers for remote downloads.</li>
<li><code>download.timeoutSec</code> (number, optional): remote timeout seconds (default 60 when supported by the host PowerShell).</li>
<li><code>download.useCache</code> (boolean, optional): use per-user cache (default <code>true</code>).</li>
<li><code>download.overwrite</code> (boolean, optional): overwrite <code>dest</code> if it exists (default <code>false</code>).</li>
<li><code>download.extract</code> (boolean, optional): if <code>true</code>, treat the downloaded file as a ZIP and extract it safely (zip-slip protected).</li>
<li><code>download.extractTo</code> (string, required if <code>extract: true</code>): directory to extract into.</li>
</ul>

<h4>Idempotency check for download</h4>

<p>Supported checks:</p>

<ul>
<li><code>check.type: "pathExists"</code> with <code>check.path</code> (defaults to <code>download.dest</code> when omitted)</li>
<li><code>check.type: "fileHashEquals"</code> with:
<ul>
<li><code>check.path</code> (defaults to <code>download.dest</code> when omitted)</li>
<li><code>check.sha256</code> (required)</li>
</ul></li>
</ul>

<p>Notes:
- If <code>download.dest</code> already exists and <code>download.overwrite</code> is <code>false</code>, the runner will skip only if <code>download.sha256</code> matches the destination; otherwise it fails fast.</p>

</body>
</html>
