<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Module_Settings_UI_Binding_Spec_v1.md</title>
<style>
body { font-family: system-ui, Segoe UI, Arial, sans-serif; margin: 2rem; line-height: 1.5; max-width: 1100px; }
pre { white-space: pre-wrap; word-wrap: break-word; background: #f6f8fa; padding: 1rem; border-radius: 12px; }
code { background: #f6f8fa; padding: 0.1rem 0.2rem; border-radius: 6px; }
a { color: #0b57d0; }
table { border-collapse: collapse; }
td, th { border: 1px solid #ddd; padding: 6px 10px; }
</style>
</head>
<body>
<h1>Module Settings UI Binding Spec v1</h1>

<p>This document defines how <code>module.json</code> declares settings pages and how the Framework renders them consistently.</p>

<h2>1. Design goals</h2>

<ul>
<li>Module authors declare <em>what</em> settings exist; Framework decides <em>how</em> they look.</li>
<li>Settings are namespaced under <code>Framework.Modules.&lt;ModuleId&gt;.*</code>.</li>
<li>Three-tier storage: policy/machine/user.</li>
<li>UI is generated from declarative schema, with optional custom panels for advanced modules.</li>
</ul>

<h2>2. Settings object (module.json)</h2>

<p>A module declares:
- <code>settings.rootKey</code>: base prefix for settings keys
- <code>settings.storageScopes</code>: mapping of patterns to scope (policy/machine/user)
- <code>settings.pages</code>: list of pages</p>

<h3>2.1 Page schema</h3>

<p>Each settings page:
- <code>id</code> (string)
- <code>title</code> (string)
- <code>route</code> (string)
- <code>groups</code> (array)</p>

<h3>2.2 Group schema</h3>

<p>Each group:
- <code>id</code>, <code>title</code>
- <code>controls</code> (array)</p>

<h3>2.3 Control schema</h3>

<p>Each control is rendered by type.</p>

<p>Common fields:
- <code>key</code> (relative to rootKey)
- <code>type</code> (enum)
- <code>title</code>, <code>description</code>
- <code>default</code>
- <code>scopeHint</code> (optional override)
- <code>requiresCapability</code> (optional)
- <code>risk</code> (optional: Safe/Caution/Unsafe)
- <code>visibleWhen</code> (optional expression)</p>

<p>Types:
- <code>toggle</code> (bool)
- <code>text</code> (string)
- <code>path</code> (string)
- <code>number</code> (int/float)
- <code>dropdown</code> (enum)
- <code>multiselect</code> (string[])
- <code>table</code> (array of objects)
- <code>button</code> (action)</p>

<h2>3. Expressions (visibleWhen)</h2>

<p>Small expression language:
- comparisons, boolean ops, key lookups
Example:
- <code>visibleWhen</code>: <code>policy.strictAllowlist == false &amp;&amp; user.ui.showAdvanced == true</code></p>

<h2>4. Binding rules</h2>

<ul>
<li>Full key = <code>settings.rootKey + '.' + control.key</code></li>
<li>Scope is determined by:
1) <code>scopeHint</code> if present
2) first matching pattern in <code>settings.storageScopes</code>
3) fallback to <code>user</code></li>
</ul>

<h2>5. Validation rules</h2>

<ul>
<li>All keys must be unique per module.</li>
<li>Controls requiring capabilities must declare <code>requiresCapability</code>.</li>
<li>Unsafe toggles must carry <code>risk: Unsafe</code>.</li>
</ul>

<h2>6. Example controls</h2>

<div class="codehilite">
<pre><span></span><code><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;apps.settings&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;AppSCrawler Settings&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;route&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;/apps/settings&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;groups&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;risk&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Risk &amp; Safety&quot;</span><span class="p">,</span>
<span class="w">      </span><span class="nt">&quot;controls&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;risk.allowUnsafe&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;toggle&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Allow unsafe actions&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;default&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;risk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Unsafe&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;requiresCapability&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;cap.software.registry_uninstall_unsafe&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="p">{</span><span class="w"> </span><span class="nt">&quot;key&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;approval.require&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;toggle&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;title&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Require plan approval&quot;</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;default&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span><span class="w"> </span><span class="nt">&quot;risk&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Caution&quot;</span><span class="w"> </span><span class="p">}</span>
<span class="w">      </span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">]</span>
<span class="p">}</span>
</code></pre>
</div>

</body>
</html>
