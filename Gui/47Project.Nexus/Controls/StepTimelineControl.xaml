<UserControl x:Class="_47Project.Nexus.Controls.StepTimelineControl"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="clr-namespace:_47Project.Nexus.Converters"
             Background="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=Background}">
              <Border.Effect>
                <DropShadowEffect Color="#8800FF66" BlurRadius="14" ShadowDepth="0" Opacity="0"/>
              </Border.Effect>
  <UserControl.Resources>
    <conv:StatusToBrushConverter x:Key="StatusToBrush"/>
    <conv:StatusToGlyphConverter x:Key="StatusToGlyph"/>
  </UserControl.Resources>

  <Border Background="{DynamicResource App.Surface}" BorderBrush="{DynamicResource App.Border}"
          BorderThickness="1" CornerRadius="14" Padding="10">
    <DockPanel LastChildFill="True">
      <StackPanel DockPanel.Dock="Top" Margin="4,0,0,10">
        <DockPanel>
          <TextBlock Text="Steps" FontWeight="SemiBold" />
          <TextBlock DockPanel.Dock="Right" Foreground="{DynamicResource App.SubtleText}" FontSize="12">
            <TextBlock.Text>
              <MultiBinding StringFormat="{}{0}/{1}">
                <Binding Path="CompletedSteps"/>
                <Binding Path="TotalSteps"/>
              </MultiBinding>
            </TextBlock.Text>
          </TextBlock>
        </DockPanel>
        <ProgressBar Height="6" Margin="0,8,6,0" Value="{Binding Progress01}" Maximum="1"/>
      </StackPanel>

      <ListBox ItemsSource="{Binding ItemsSource, RelativeSource={RelativeSource AncestorType=UserControl}}"
               SelectedItem="{Binding SelectedItem, RelativeSource={RelativeSource AncestorType=UserControl}, Mode=TwoWay}"
               BorderThickness="0" Background="Transparent"
               ScrollViewer.VerticalScrollBarVisibility="Auto">
      <ListBox.ItemContainerStyle>
        <Style TargetType="ListBoxItem">
          <Setter Property="Background" Value="Transparent"/>
          <Setter Property="BorderBrush" Value="{DynamicResource App.Border}"/>
          <Setter Property="BorderThickness" Value="0"/>
          <Style.Triggers>
            <Trigger Property="IsSelected" Value="True">
              <Setter Property="Background" Value="#1A00FF66"/>
              <Setter Property="BorderBrush" Value="{DynamicResource App.Accent}"/>
              <Setter Property="BorderThickness" Value="1"/>
            </Trigger>
          </Style.Triggers>
        </Style>
      </ListBox.ItemContainerStyle>

        <ListBox.ItemTemplate>
          <DataTemplate>
            <Border CornerRadius="12" Padding="10" Margin="4,3"
                    BorderBrush="{DynamicResource App.Border}" BorderThickness="1"
                    Background="{Binding RelativeSource={RelativeSource AncestorType=ListBoxItem}, Path=Background}">
              <Border.Effect>
                <DropShadowEffect Color="#8800FF66" BlurRadius="14" ShadowDepth="0" Opacity="0"/>
              </Border.Effect>
              <Grid>
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="34"/>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <Grid Grid.Column="0" Width="34" Margin="0,0,8,0">
                  <Grid>
                    <Rectangle Width="2" HorizontalAlignment="Center" VerticalAlignment="Stretch"
                               Fill="{DynamicResource App.Border}" Opacity="0.55"/>
                    <Border Width="24" Height="24" CornerRadius="12"
                            Background="{DynamicResource App.Surface}"
                            BorderBrush="{DynamicResource App.Border}" BorderThickness="1"
                            VerticalAlignment="Top" Margin="0,2,0,0">
                      <TextBlock Text="{Binding Status, Converter={StaticResource StatusToGlyph}}"
                                 HorizontalAlignment="Center" VerticalAlignment="Center"
                                 FontSize="14"
                                 Foreground="{Binding Status, Converter={StaticResource StatusToBrush}}"/>
                    </Border>
                  </Grid>
                </Grid>
<StackPanel Grid.Column="1">
                  <TextBlock Text="{Binding StepId}" FontWeight="SemiBold"/>
                  <TextBlock Text="{Binding StepType}" Foreground="{DynamicResource App.SubtleText}" FontSize="12"/>
                  <TextBlock Text="{Binding Message}" Foreground="{DynamicResource App.SubtleText}" FontSize="12"
                             TextTrimming="CharacterEllipsis" MaxHeight="34"/>
                </StackPanel>

                <StackPanel Grid.Column="2" HorizontalAlignment="Right">
                  <TextBlock Text="{Binding Status}"
                             Foreground="{Binding Status, Converter={StaticResource StatusToBrush}}"
                             FontWeight="SemiBold" HorizontalAlignment="Right"/>
                  <TextBlock FontSize="12" Foreground="{DynamicResource App.SubtleText}" HorizontalAlignment="Right">
                    <TextBlock.Text>
                      <MultiBinding StringFormat="{}{0:mm\:ss}">
                        <Binding Path="Duration"/>
                      </MultiBinding>
                    </TextBlock.Text>
                  </TextBlock>
                </StackPanel>
              </Grid>
            </Border>
          </DataTemplate>
        </ListBox.ItemTemplate>
      </ListBox>
    </DockPanel>
  </Border>
</UserControl>
